# [Algorithm] 股票之神

- 命题人：ranwen
- 我是巴菲特：100 分
- 我是股票女王：150 分
- 我是股票之神：250 分

## 题目描述

<blockquote>
<p>小 P 在为一家 prop firm 公司工作，但她的交易水平确实有待提升。离考核期只剩 15 分钟，她要是无法达到业绩要求就只能背负巨额赔偿金了。她向股票之神祈祷：</p>
<p>小 P：股票之神啊，请你教教我如何在市场上快速盈利。</p>
<p>股票之神：你可以去学习大佬的交易秘诀。</p>
<p>小 P：那能您能告诉我巴菲特的交易秘诀吗？</p>
<p>股票之神：他的秘诀是，只在最便宜最值得的时候买入，在价格高到不足以支撑业绩时卖出。不过他的长线玩法可能不适合你，他最近的收益率只有 20%。</p>
<p>小 P：那 P████i 呢？</p>
<p>股票之神：她的消息非常灵通，这足以让她在消息被公众知道之前提前完成建仓，这让她取得了 50% 的收益率。你没有她的渠道，恐怕很难掌握正确的时机。</p>
<p>小 P：那 T███p 呢？</p>
<p>股票之神：好久没有人用这个名字称呼我了。</p>
<p>股票之神：既然你诚心诚意地发问了，那我就大发慈悲地告诉你。我最近资产增长率 80%。</p>
<p>股票之神：我会把我和<a target="_blank" rel="noopener noreferrer" href="https://www.whitehouse.gov/articles/2025/04/remarks-by-director-kratsios-at-the-endless-frontiers-retreat/#:~:text=Our%20technologies%20permit%20us%20to%20manipulate%20time%20and%20space.">我同事</a>的力量借予你。至于到底如何使用，就要靠你自己把握了。</p>
<p>股票之神：你帮我教训教训██街的人们，让他们知道，在真正的力量面前，<strong>算法</strong>根本不值一提。</p>
<p>股票之神：对了，再提醒你一下，现金落袋了才是真收益。</p>
</blockquote>
<p>你需要在题目的交易平台上于<strong> 9000 Tick 收盘前</strong>分别达到 20%、50% 和 80% 的<strong>现金</strong>收益率以依此取得三个 flag。</p>
<blockquote>
<p>本题题目背景和题目内容均为杜撰，不构成任何投资参考和建议。投资有风险，入市需谨慎。</p>
</blockquote>
<p><strong>提示：</strong></p>
<ul>
<li>题目的撮合机制为简易实现，每个 tick 总是按照固定顺序处理报单。详情参考 Exchange 中 run_simulation 和 _match_orders 部分。</li>
<li>附件中提供了完整的程序源码，你不需要、也不建议完整阅读全部。附件中还附有一套 Python SDK，你可以基于这个进行开发（但请注意该 SDK 调用是阻塞的），或自行实现接口调用。</li>
<li>如果你的策略需要的 tick 数量较多，或需要较高时间精度，建议在本地测试通过后再进行线上提交。本地延迟较为稳定，可以使用更快的时间流逝速度进行测试。</li>
<li>两个做市商分别为修改版恒定函数做市商（CFMM）和简化版 Avellaneda-Stoikov 算法做市商。</li>
<li>散户的钱也是钱。</li>
<li>你可能不需要完全理解以上提示，也可能不需要写代码，通过尝试和观察可能也足以解决本题部分或全部。</li>
</ul>
<p><strong>补充说明：</strong></p>
<ul>
<li>本题的重开是通过重启服务实现的。如果遇到服务器负载过大等情况可能需要您多等待几秒钟后手动刷新。</li>
<li>题目的环境和附件有更新，修复了当成交单双方为同一对象时记账错误的逻辑漏洞。该漏洞与题目解法无关，且通常不会影响您解题。如果您的实例正在运行中，您可以按需重新启动实例以应用该漏洞修复。</li>
</ul>
<div class="well">
<p><strong>第二阶段提示：</strong></p>
<ul>
<li>
<p>题目的资金量已经足以操纵市场、影响价格。注意算法做市商总是根据之前的成交价进行报价的。</p>
</li>
<li>
<p>学习一下大额单对市场价格的影响以及如何减缓（或利用）。</p>
</li>
<li>
<p>只在合适的时候操纵价格。价格过高过低时操纵效果可能有限，且流动性下降导致单边交易对市场的影响会被放大。</p>
</li>
<li>
<p>前两个 Flag 真的可以很容易手打。</p>
</li>
</ul>
</div>

**[【附件：下载题目附件（market.zip）】](attachment/market.zip)**

**【网页链接：访问题目网页】**

## 预期解法

题目中模拟了一个交易市场。市场中拥有两类不同的算法做市商，用户和散户。用户拥有恰好足以操纵市场的资金量，同时还拥有发送新闻改变市场预期的能力，需要让现金增长 80% 以获得 flag 。

题目预期解法的核心是，利用做市商总是根据最新价格进行报价的特点（或者说缺陷）。即在价格操纵发生前后，做市商总是会围绕这个最新价格进行报价的，进而给市场提供足够的流动性。而在价格操纵过程中的单边行情下，由于做市商总是希望自己的持仓为 0，在价格操纵中持仓会产生偏离，需要反向下单，因此反而会助推价格操纵（例如：当大幅买入时，做市商的卖单会成交，因此做市商希望再买回持仓，因此会下价格更高的买单），进而产生亏损。不过题目中的 CFMM 并没有这个特点：CFMM 的报单量和库存总是正相关的。

解决本题的核心操作有两点：

- 合适的下单方法。在需要低位建仓时，使用 TWAP、盘口挂单等技巧来保证市场价格不会大幅变动。在需要操纵价格时，通过连续报比盘口略高的价以实现低成本的拉升。同时，下单也可以结合做市算法，在中间价的两边进行有偏向的报单（例如买单挂-0.1%，卖单挂+0.5%），并尽可能报出比 CFMM 好的价格（避免让别人赚钱）。某些场景下也不建议使用最新成交价作为报价参考，可采用最近成交加权平均价格作为参照价格。
- 合适的时机出手。例如，做市商总是在市场价格稳定的时候会提供更好的报价，散户的交易也会更加随机。在价格为 100 时，散户和做市商均能提供较为均衡的流动性，无论是要操纵价格还是稳定价格均会更容易。总是在上次价格已经相对稳定时再进行下一次市场操纵（或者发送新闻）。

对于前两个 flag，分别只需要取得 20% 和 50% 的收益率。这两档是专门为手动玩家设计的，且对下单方法要求偏低。一种可行的方法是：开局发三次新闻让价格下降，每次发完要稍作等待。之后手动 TWAP，例如每次使用中间价下 1000 股的 1 tick 取消单。下单结束后，使用剩余的次数抬升价格。最后再使用 TWAP 卖出。实际上我手动测试了好几种（点击次数不超过几百次的）方案，基本都可以稳定取得 7m-8m 的收益，足以通过前两档。

对于第三个 flag，就需要结合上述更多的操作了。我的做法大致如下：

- 总共分十轮，每一轮需要使用一个新闻进行拉升。
- 每一轮开始时，使用 80% 的资金进行 TWAP 低价买入。
- 低价买入后，发送新闻拉升，AS 做市商的持仓会变负，不会挂低价卖单。趁这个卖方流动性真空的情况下进一步挂更多的买单以拉升价格。
- 休息一段时间，通过做市的方法让价格稳定。此处我使用了带偏好的做市，价格可能会进一步被抬升。
- 采用 TWAP 和做市结合的方法进行卖出。具体地，在执行 TWAP 卖出时，同时挂入价格更低的买单，避免价格崩塌过快。
- 对于剩余没有卖出的部分，强行卖出，但加入限价，避免因缺失流动性而造成亏损。这个部分其实可以不需要，但是对上述卖出的价格时间等需要进行更精细的控制。
- 等待价格稳定后进入下一轮。

我在出题中写过多个足以通过本题的做法。该做法并不是效率最高的方法，但是其流程较为简便。其他做法中，还涉及到计算方差、模仿做市。但由于我懒得做正经计算，这些东西都充斥着大量的 magic number，观感不是很好。

这个做法（的某一个版本）有较大概率在 6-8 轮中取得 10m 的资金。但本题市场在早期和后期的特性差异较大，我懒得调了。因此后期可能需要手动进行出货。

## 题目设计

本题代码均为大模型产物。其中前端 vibe 浓度高达 95%（在我指导 LLM 进行修改后手动调整了一些 css），后端 vibe 浓度高达 80%（本来可以更高，但是 LLM 确实还是写出了不少 bug）。~~出锅不要怪我，去怪 OpenAI/DeepSeek/Kimi~~。为什么不建议选手阅读代码，因为我也没有阅读完。要是被发现了我没有发现的 bug 就难绷了~~（结果还真的有）~~。

本题设计思路其实还是从做市商入手的。我在跟别人聊天时，发现很多人都有一个误区：做市商永远是 Delta 中性的，无论是什么行情下都能赚钱。但其实做市商只能尽可能地保持 Delta 中性（或符合预期），只有在市场走向符合他们模型的时候才能赚钱。一个经典的例子就是加密货币在 10 月 11 日的极端行情，有很多做市商都在这波行情中产生了大额亏损。当然，做市商也可以非常坏：他们手中的头寸也足以进行价格操纵，除非遇到了黑天鹅事件，否则他们是可以通过价格操纵本身进行获利的。这时候当然也不需要保持 Delta 中性。有一些经典的例子：DWF Labs，还有 MYX。

回到正经做市商。本题的 CFMM 显然是很稳健的策略，但是面临着收益不高以及所谓无常损失的问题。本题使用的做市商是 AS 算法的简化版，简化是因为我也没学明白。但核心思想比较简单：做市商永远尽可能 Delta 中性，并根据当前市场的波动性对围绕参照价格进行报价，而参照价格是根据做市商持仓进行调整的，使得做市商总是更倾向于回归 Delta 中性。当波动较大时，做市商的报价会更稀疏，同时参照价格调整也会更为极端。由于我没学明白，本题的做市有以下可以被利用的漏洞：做市参数充斥 magic number，比如 $\kappa$ ，方差价格归一化参数等，均是手动调参调的，而当市场价格和流动性发生改变时该参数会失效；每次报单数额几乎是定额，这使得当价格过低或过高时，做市商会提供过差或过于极端的流动性。

出题时非常难受的是，为了保证题目的可做性和合理性，我需要同时调整解法和做市商的各种参数。以保证做市商在正常情况下是正收益的，而在用户攻击下是负收益的。事实上某些做市参数非常健壮，我试了各种方法都难以进行大额攻击（只会产生小额亏损），只是这个参数也不怎么赚钱。另外本题最初并不想给足以操纵市场的资金量。但在更少的资金量的情况下，随机事件的影响会被放大，为了区分出不同做法，必须加长开盘时间，这会使得无论时手点还是脚本体验都变差。因此最终还是给了 5m 初始资金。

本题还有一个故意引入的漏洞。注意到每 tick 价格是成交均价，AS 做市商也是根据上次均价进行报价的。而题目中并没有防止自成交，因此可以利用这个特性进行 wash trading，操控成交均价。不过我测试了感觉效果有限。而且需要高度自动化。出题时我没有注意到的一点是，AS 做市商由于仓位不平衡会导致报价偏移，而这会使得成交价进一步偏差，进而再次造成偏移。而散户的滑点很大，因此也总会以更差的价格成交。因此有的时候你施加一个初始动量，交易价格就会长期持续抬升（虽然实际上亏损最多的是散户）。这是一个概率问题，取决于散户的行为如何。现在看起来我对散户的设置还是太中性了，即便当前价比预期价高了 10%，散户平均也只有 55% 概率选择卖出方向，应当根据预期价和仓位做更激进的平衡，以避免这个问题。

另外本题散户的身份也很有意思。散户会根据预期价和持仓比例进行调仓。但在价格操纵过程中，被割得最狠得也是散户。散户交易行为比较随机，挂单滑点较大，在成交顺位上也比较靠后，因此容易产生亏损。当然，如果你的手法过差（例如一次性挂了一个超大超高价单），可能反而会被散户割。散户比较多的前期和散户全都被洗出去的后期，最优操盘手法差异会比较大。例如，散户都被洗出去后，去做 wash trading 操纵会容易不少。

本题实现有一个我特意指定的方案。持仓管理不在交易所层级实现，而是由参与方自行实现。这实际上是为了保证做市商可以更方便地充当大血包（虽然也引起了一个漏洞）。市场上的股票和金钱总和正常情况下都是固定的，所以赚大钱只能从做市商手上赚。

引入 Truth 的设定，一是为了更好的贴合题目背景，二也是考虑到题目定位（让大家觉得好玩，且能手玩）。其实只凭资金进行价格操纵也是可行的。

本题 Web 界面的下单功能，是我（和 xmcp）在多次手点后总结体验设计的，LLM 这块不太行。

本题由 LLM 实现了多个不是我刻意留的漏洞。我没有仔细审计，因此有一些留到了比赛中。目前已知漏洞如下：

- 用户委托无法正常处理成交。这个在我测试时已经发现，并在上线时修复。当委托发生成交时，LLM 写的代码是按委托时间而不是价格进行处理的。这太怪了。
- 无法处理自成交。首先 LLM 写的代码里面也没有判断这个东西。当自成交发生时，on_trade 通知只会被发出一次。这个问题是题目上线后有选手反馈我才发现。严格来讲这是会使得题目更容易通过的，因为这允许用户通过虚空造股并在不造成价格影响的情况下买入。不过当时过题人数不多，可能也没有其他人发现，并且想要通过本题还是需要在卖出的过程中应用下单技巧，所以我就修改了题目实例。
- 算钱用浮点。这个懂的都懂了。我当时看到了还想了想，以为只是精度问题罢了，没啥大毛病，结果哈哈了。

另外总体来讲 GPT5-Codex 的逻辑能力还是比较强的。例如本题的两个做市商还有散户的主要逻辑都是 LLM 写的。其他模型写不出来。

## 其他做法

- 如果你是交易高手，可以试试什么 MACD KDJ 交易。虽然这个应该不太行。用一用网格交易马丁交易说不定能取得一定的收益，但应该也不足以通过本题。
- 如果你是高频量化大师，可以利用 AS 做市商报价的特性，在前一个 tick 内吃掉单后，在下一个 tick 时立刻提供对手单。但 AS 做市商一次报单量有点小，应该只能在大后期如此赚大钱。
- 如果你运气很好，应该可以发现上述 AS 做市商会造成市场价格持续偏移的问题，并且在做题时多次都取得了正向的偏移，因此得以拉高出货。不幸的是，我在验题时多次都获得了向下的偏移，我以为是我的仓位平衡参数设置过大了，导致价格回归，因此调低了仓位平衡参数并把题目目标缩小到了 80%。
- 如果你是人形机器人，你完全可以手点通过本题。总点击次数也就是千次左右，主要是因为仍然得才用多轮多次的进货出货。有多个选手都是手点过题的（这大概也是因为上述的设计错误），甚至还有神人手点到了 100 亿。我知道做市商在资金比较多的时候会完全失效，可以指数刷钱，但是我以为 9000 ticks 最多也就是点到 20-30m。
- 如果你是代码审计（LLM）大师，你甚至可以发现本题的漏洞。有选手发现了本题不仅算钱用了浮点，在输入部分甚至没有做任何检查。因此下单价格可以传入 NaN。这尽管不能让你发出有效订单及直接通过本题，但这会使得题目中的可用资金也变为 NaN，因此挂单可以无视资金限制，相当于获得了无限大的杠杆。既然有了无限本金，那过题也没有什么难度了（尽管还是需要一些下单手法）。
